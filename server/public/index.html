<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Song Guessr - ç®¡ç†é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Comic Neue', cursive; }
    .hand-font { font-family: 'Caveat', cursive; }
    .sketch-border { border: 2px solid #2d2d2d; box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2); }
    .paper-bg { background-color: #faf8f5; }
  </style>
</head>
<body class="paper-bg min-h-screen">
  <div id="app">
    <!-- ç™»å½•é¡µ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center">
      <div class="sketch-border rounded-xl p-8 bg-white max-w-md w-full mx-4">
        <h1 class="hand-font text-4xl text-center mb-6">ğŸµ Song Guessr</h1>
        <h2 class="text-xl text-center mb-8 text-gray-600">ç®¡ç†é¢æ¿</h2>
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">ç”¨æˆ·å</label>
            <input type="text" id="username" class="w-full px-4 py-2 sketch-border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm mb-1">å¯†ç </label>
            <input type="password" id="password" class="w-full px-4 py-2 sketch-border rounded-lg" required>
          </div>
          <button type="submit" class="w-full py-3 sketch-border rounded-lg bg-orange-400 text-white font-bold hover:-translate-y-0.5 transition-transform">
            ç™»å½•
          </button>
          <p id="login-error" class="text-red-500 text-center text-sm hidden"></p>
        </form>
      </div>
    </div>

    <!-- ä¸»é¢æ¿ -->
    <div id="admin-panel" class="hidden">
      <!-- å¯¼èˆªæ  -->
      <nav class="sketch-border bg-white mb-6">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
          <h1 class="hand-font text-2xl">ğŸµ Song Guessr ç®¡ç†</h1>
          <div class="flex items-center gap-4">
            <span id="admin-username" class="text-gray-600"></span>
            <button onclick="logout()" class="px-4 py-2 sketch-border rounded-lg hover:bg-gray-100">é€€å‡º</button>
          </div>
        </div>
      </nav>

      <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Tabå¯¼èˆª -->
        <div class="flex gap-2 mb-6 overflow-x-auto">
          <button onclick="switchTab('dashboard')" class="tab-btn px-6 py-2 sketch-border rounded-lg bg-orange-400 text-white" data-tab="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</button>
          <button onclick="switchTab('rooms')" class="tab-btn px-6 py-2 sketch-border rounded-lg bg-white" data-tab="rooms">ğŸ  æˆ¿é—´ç®¡ç†</button>
          <button onclick="switchTab('stats')" class="tab-btn px-6 py-2 sketch-border rounded-lg bg-white" data-tab="stats">ğŸ“ˆ æ¸¸æˆç»Ÿè®¡</button>
          <button onclick="switchTab('errors')" class="tab-btn px-6 py-2 sketch-border rounded-lg bg-white" data-tab="errors">âš ï¸ é”™è¯¯æ—¥å¿—</button>
          <button onclick="switchTab('telemetry')" class="tab-btn px-6 py-2 sketch-border rounded-lg bg-white" data-tab="telemetry">ğŸ“¡ é¥æµ‹æ•°æ®</button>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div id="tab-dashboard" class="tab-content">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="sketch-border rounded-xl p-4 bg-white">
              <div class="text-3xl mb-2">ğŸ®</div>
              <div class="text-2xl font-bold" id="stat-total-games">-</div>
              <div class="text-gray-500 text-sm">æ€»æ¸¸æˆæ•°</div>
            </div>
            <div class="sketch-border rounded-xl p-4 bg-white">
              <div class="text-3xl mb-2">ğŸ‘¥</div>
              <div class="text-2xl font-bold" id="stat-total-players">-</div>
              <div class="text-gray-500 text-sm">æ€»ç©å®¶æ•°</div>
            </div>
            <div class="sketch-border rounded-xl p-4 bg-white">
              <div class="text-3xl mb-2">ğŸŸ¢</div>
              <div class="text-2xl font-bold" id="stat-active-today">-</div>
              <div class="text-gray-500 text-sm">ä»Šæ—¥æ´»è·ƒ</div>
            </div>
            <div class="sketch-border rounded-xl p-4 bg-white">
              <div class="text-3xl mb-2">âš ï¸</div>
              <div class="text-2xl font-bold" id="stat-errors">-</div>
              <div class="text-gray-500 text-sm">24hé”™è¯¯</div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="sketch-border rounded-xl p-4 bg-white">
              <h3 class="hand-font text-xl mb-4">ğŸ† æ’è¡Œæ¦œ</h3>
              <div id="leaderboard" class="space-y-2"></div>
            </div>
            <div class="sketch-border rounded-xl p-4 bg-white">
              <h3 class="hand-font text-xl mb-4">ğŸ“Š æœ€è¿‘æ¸¸æˆ</h3>
              <div id="recent-games" class="space-y-2"></div>
            </div>
          </div>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div id="tab-rooms" class="tab-content hidden">
          <div class="sketch-border rounded-xl p-4 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="hand-font text-xl">ğŸ  æ´»è·ƒæˆ¿é—´</h3>
              <button onclick="loadRooms()" class="px-4 py-2 sketch-border rounded-lg hover:bg-gray-100">åˆ·æ–°</button>
            </div>
            <div id="rooms-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- æ¸¸æˆç»Ÿè®¡ -->
        <div id="tab-stats" class="tab-content hidden">
          <div class="sketch-border rounded-xl p-4 bg-white">
            <h3 class="hand-font text-xl mb-4">ğŸ“ˆ æ¸¸æˆå†å²</h3>
            <div id="game-stats-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- é”™è¯¯æ—¥å¿— -->
        <div id="tab-errors" class="tab-content hidden">
          <div class="sketch-border rounded-xl p-4 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="hand-font text-xl">âš ï¸ é”™è¯¯æ—¥å¿—</h3>
              <div class="flex gap-2">
                <select id="error-source" onchange="loadErrors()" class="px-3 py-2 sketch-border rounded-lg">
                  <option value="">æ‰€æœ‰æ¥æº</option>
                  <option value="client">å®¢æˆ·ç«¯</option>
                  <option value="server">æœåŠ¡ç«¯</option>
                </select>
              </div>
            </div>
            <div id="errors-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- é¥æµ‹æ•°æ® -->
        <div id="tab-telemetry" class="tab-content hidden">
          <div class="sketch-border rounded-xl p-4 bg-white">
            <h3 class="hand-font text-xl mb-4">ğŸ“¡ é¥æµ‹æ•°æ®</h3>
            <div id="telemetry-list" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('admin_token');
    let currentTab = 'dashboard';

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (token) {
      showAdminPanel();
      loadDashboard();
    }

    // ç™»å½•
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) throw new Error('ç™»å½•å¤±è´¥');

        const data = await res.json();
        token = data.token;
        localStorage.setItem('admin_token', token);
        document.getElementById('admin-username').textContent = data.admin.username;
        showAdminPanel();
        loadDashboard();
      } catch (err) {
        document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        document.getElementById('login-error').classList.remove('hidden');
      }
    });

    function showAdminPanel() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('admin-panel').classList.remove('hidden');
    }

    function logout() {
      token = null;
      localStorage.removeItem('admin_token');
      location.reload();
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-orange-400', 'text-white');
        btn.classList.add('bg-white');
      });
      document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-orange-400', 'text-white');
      document.querySelector(`[data-tab="${tab}"]`).classList.remove('bg-white');

      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');

      if (tab === 'dashboard') loadDashboard();
      else if (tab === 'rooms') loadRooms();
      else if (tab === 'stats') loadGameStats();
      else if (tab === 'errors') loadErrors();
      else if (tab === 'telemetry') loadTelemetry();
    }

    async function apiGet(endpoint) {
      const res = await fetch(endpoint, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        if (res.status === 401) {
          logout();
          throw new Error('è®¤è¯å¤±è´¥');
        }
        throw new Error('è¯·æ±‚å¤±è´¥');
      }
      return res.json();
    }

    async function apiDelete(endpoint) {
      const res = await fetch(endpoint, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return res.ok;
    }

    async function loadDashboard() {
      try {
        const data = await apiGet('/api/admin/dashboard');
        document.getElementById('stat-total-games').textContent = data.totalGames;
        document.getElementById('stat-total-players').textContent = data.totalPlayers;
        document.getElementById('stat-active-today').textContent = data.activeToday;
        document.getElementById('stat-errors').textContent = data.errorCount24h;

        // æ’è¡Œæ¦œ
        document.getElementById('leaderboard').innerHTML = data.topPlayers.map((p, i) => `
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
            <span>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i+1)+'.'} ${p.playerName}</span>
            <span class="font-bold">${p.totalScore} åˆ†</span>
          </div>
        `).join('');

        // æœ€è¿‘æ¸¸æˆ
        document.getElementById('recent-games').innerHTML = data.recentGames.map(g => `
          <div class="p-2 bg-gray-50 rounded">
            <div class="flex justify-between">
              <span class="font-bold">${g.roomName}</span>
              <span class="text-gray-500 text-sm">${new Date(g.startTime).toLocaleString()}</span>
            </div>
            <div class="text-sm text-gray-500">ç©å®¶: ${g.playerCount} | å›åˆ: ${g.roundCount}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', err);
      }
    }

    async function loadRooms() {
      try {
        const rooms = await apiGet('/api/admin/rooms');
        document.getElementById('rooms-list').innerHTML = rooms.length === 0 
          ? '<p class="text-gray-500 text-center py-4">æš‚æ— æ´»è·ƒæˆ¿é—´</p>'
          : rooms.map(r => `
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
              <div>
                <div class="font-bold">${r.name} ${r.isPrivate ? 'ğŸ”’' : ''}</div>
                <div class="text-sm text-gray-500">
                  æˆ¿ä¸»: ${r.hostName} | ç©å®¶: ${r.playerCount}/${r.maxPlayers} | çŠ¶æ€: ${r.status}
                </div>
              </div>
              <button onclick="dissolveRoom('${r.id}')" class="px-3 py-1 sketch-border rounded bg-red-100 text-red-600 hover:bg-red-200">
                è§£æ•£
              </button>
            </div>
          `).join('');
      } catch (err) {
        console.error('åŠ è½½æˆ¿é—´å¤±è´¥:', err);
      }
    }

    async function dissolveRoom(roomId) {
      if (!confirm('ç¡®å®šè¦è§£æ•£è¿™ä¸ªæˆ¿é—´å—ï¼Ÿ')) return;
      await apiDelete(`/api/admin/rooms/${roomId}`);
      loadRooms();
    }

    async function loadGameStats() {
      try {
        const { data } = await apiGet('/api/admin/stats/games?limit=20');
        document.getElementById('game-stats-list').innerHTML = data.map(g => `
          <div class="p-3 bg-gray-50 rounded">
            <div class="flex justify-between">
              <span class="font-bold">${g.roomName}</span>
              <span class="${g.completed ? 'text-green-600' : 'text-yellow-600'}">${g.completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span>
            </div>
            <div class="text-sm text-gray-500">
              æˆ¿ä¸»: ${g.hostName} | ç©å®¶: ${g.playerCount} | å›åˆ: ${g.roundCount}
            </div>
            <div class="text-xs text-gray-400">${new Date(g.startTime).toLocaleString()}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½æ¸¸æˆç»Ÿè®¡å¤±è´¥:', err);
      }
    }

    async function loadErrors() {
      try {
        const source = document.getElementById('error-source').value;
        const { data } = await apiGet(`/api/admin/telemetry?type=error${source ? '&source=' + source : ''}&limit=50`);
        document.getElementById('errors-list').innerHTML = data.length === 0
          ? '<p class="text-gray-500 text-center py-4">æš‚æ— é”™è¯¯æ—¥å¿—</p>'
          : data.map(e => `
            <div class="p-3 bg-red-50 rounded border-l-4 border-red-400">
              <div class="flex justify-between">
                <span class="font-bold text-red-700">${e.source === 'client' ? 'ğŸ–¥ï¸ å®¢æˆ·ç«¯' : 'ğŸ–§ æœåŠ¡ç«¯'}</span>
                <span class="text-gray-500 text-xs">${new Date(e.timestamp).toLocaleString()}</span>
              </div>
              <div class="text-sm mt-1">${e.message || 'æ— æ¶ˆæ¯'}</div>
              ${e.stack ? `<pre class="text-xs text-gray-500 mt-2 overflow-auto max-h-20">${e.stack}</pre>` : ''}
            </div>
          `).join('');
      } catch (err) {
        console.error('åŠ è½½é”™è¯¯æ—¥å¿—å¤±è´¥:', err);
      }
    }

    async function loadTelemetry() {
      try {
        const { data } = await apiGet('/api/admin/telemetry?limit=50');
        document.getElementById('telemetry-list').innerHTML = data.map(t => `
          <div class="p-3 bg-gray-50 rounded">
            <div class="flex justify-between">
              <span class="font-bold">${t.type}</span>
              <span class="text-gray-500 text-xs">${new Date(t.timestamp).toLocaleString()}</span>
            </div>
            <div class="text-sm text-gray-500">${t.source} | ${t.platform || 'web'}</div>
            ${t.data ? `<pre class="text-xs text-gray-400 mt-1 overflow-auto max-h-20">${JSON.stringify(t.data, null, 2)}</pre>` : ''}
          </div>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½é¥æµ‹æ•°æ®å¤±è´¥:', err);
      }
    }
  </script>
</body>
</html>
