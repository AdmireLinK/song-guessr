<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Song Guessr - ç®¡ç†é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Comic Neue', cursive; }
    .hand-font { font-family: 'Caveat', cursive; }
    .sketch-border { border: 2px solid #2d2d2d; box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2); }
    .paper-bg { background-color: #faf8f5; }
  </style>
  <script>
    let token = null;
    let currentTab = 'dashboard';
    let activityChart;

    document.addEventListener('DOMContentLoaded', () => {
       token = localStorage.getItem('admin_token');
     
       if (token) {
         showAdminPanel();
         loadDashboard(7);
       }
     
      const loginForm = document.getElementById('login-form');
       if (loginForm) {
         loginForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           const usernameEl = document.getElementById('username');
           const passwordEl = document.getElementById('password');
           const username = usernameEl ? usernameEl.value : '';
           const password = passwordEl ? passwordEl.value : '';
           try {
             const res = await fetch('/api/admin/login', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ username, password }),
             });
             if (!res.ok) throw new Error('ç™»å½•å¤±è´¥');
             const data = await res.json();
             token = data.token;
             localStorage.setItem('admin_token', token);
             const adminUserEl = document.getElementById('admin-username');
             if (adminUserEl) adminUserEl.textContent = data.admin.username;
             showAdminPanel();
             loadDashboard(7);
           } catch (err) {
             const loginErrorEl = document.getElementById('login-error');
             if (loginErrorEl) {
               loginErrorEl.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
               loginErrorEl.classList.remove('hidden');
             }
           }
         });
       }

       // DOM å°±ç»ªåå†åˆå§‹åŒ– tabï¼Œé¿å… switchTab æ‰¾ä¸åˆ°èŠ‚ç‚¹
       switchTab('dashboard');
    });

    function showAdminPanel() {
       const loginPage = document.getElementById('login-page');
       const adminPanel = document.getElementById('admin-panel');
       if (loginPage) loginPage.classList.add('hidden');
       if (adminPanel) adminPanel.classList.remove('hidden');
    }

    function logout() {
      token = null;
      localStorage.removeItem('admin_token');
      location.reload();
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-orange-400', 'text-white');
        btn.classList.add('bg-white');
      });
      const btn = document.querySelector(`[data-tab="${tab}"]`);
      if (btn) {
        btn.classList.add('bg-orange-400', 'text-white');
        btn.classList.remove('bg-white');
      }

      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tabEl = document.getElementById(`tab-${tab}`);
      if (tabEl) {
        tabEl.classList.remove('hidden');
      } else {
        console.warn('[Admin] tab container not found:', `tab-${tab}`);
      }

      if (tab === 'dashboard') loadDashboard(7);
      else if (tab === 'rooms') loadRooms();
      else if (tab === 'errors') loadErrors();
    }

    async function apiGet(endpoint) {
      const res = await fetch(endpoint, { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) {
        if (res.status === 401) logout();
        throw new Error('è¯·æ±‚å¤±è´¥');
      }
      return res.json();
    }

    async function apiPost(endpoint, body = {}) {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
      return res.json();
    }

    async function apiDelete(endpoint) {
      const res = await fetch(endpoint, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
      return res.ok;
    }

    async function loadDashboard(range = 7) {
      try {
        document.querySelectorAll('.range-btn').forEach(btn => {
          btn.classList.toggle('bg-orange-200', btn.dataset.range == range);
        });

        const [base, activity] = await Promise.all([
          apiGet('/api/admin/dashboard'),
          apiGet(`/api/admin/activity?range=${range}`),
        ]);

        document.getElementById('stat-total-games').textContent = base.totalGames;
        document.getElementById('stat-total-players').textContent = base.totalPlayers;
        document.getElementById('stat-active-today').textContent = base.activeToday;
        document.getElementById('stat-errors').textContent = base.errorCount24h;

        document.getElementById('stat-active-ip').textContent = activity.activeIpCount;
        document.getElementById('stat-guesses').textContent = activity.guessCount;
        document.getElementById('stat-errors-range').textContent = activity.errorCount;

        document.getElementById('leaderboard').innerHTML = base.topPlayers.map((p, i) => `
          <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
            <span>${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1) + '.'} ${p.playerName}</span>
            <span class="font-bold">${p.totalScore} åˆ†</span>
          </div>
        `).join('');

        document.getElementById('recent-games').innerHTML = base.recentGames.map(g => `
          <div class="p-2 bg-gray-50 rounded">
            <div class="flex justify-between">
              <span class="font-bold">${g.roomName}</span>
              <span class="text-gray-500 text-sm">${new Date(g.startTime).toLocaleString()}</span>
            </div>
            <div class="text-sm text-gray-500">ç©å®¶: ${g.playerCount} | å›åˆ: ${g.roundCount}</div>
          </div>
        `).join('');

        const labels = activity.series.map(s => s.date);
        const guessData = activity.series.map(s => s.guesses);
        const errorData = activity.series.map(s => s.errors);
        const ipData = activity.series.map(s => s.activeIps);

        const ctx = document.getElementById('activity-chart').getContext('2d');
        if (activityChart) activityChart.destroy();
        activityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'çŒœæµ‹', data: guessData, borderColor: '#f97316', tension: 0.2 },
              { label: 'é”™è¯¯', data: errorData, borderColor: '#ef4444', tension: 0.2 },
              { label: 'æ´»è·ƒIP', data: ipData, borderColor: '#16a34a', tension: 0.2 },
            ],
          },
          options: { responsive: true, plugins: { legend: { display: true } } },
        });
      } catch (err) {
        console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', err);
      }
    }

    async function loadRooms() {
      try {
        const rooms = await apiGet('/api/admin/rooms');
        document.getElementById('rooms-list').innerHTML = rooms.length === 0
          ? '<p class="text-gray-500 text-center py-4">æš‚æ— æ´»è·ƒæˆ¿é—´</p>'
          : rooms.map(r => `
            <div class="p-3 bg-gray-50 rounded space-y-2">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-bold">${r.name} ${r.isPrivate ? 'ğŸ”’' : ''}</div>
                  <div class="text-sm text-gray-500">æˆ¿ä¸»: ${r.hostName} | ç©å®¶: ${r.playerCount}/${r.maxPlayers} | çŠ¶æ€: ${r.status}</div>
                  <div class="text-xs text-gray-400">å½“å‰è½®: ${r.currentRound || 'â€”'}</div>
                </div>
                <button onclick="dissolveRoom('${r.id}')" class="px-3 py-1 sketch-border rounded bg-red-100 text-red-600 hover:bg-red-200">è§£æ•£</button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                ${r.players.map(p => `
                  <div class="p-2 bg-white rounded sketch-border flex items-center justify-between">
                    <div>
                      <div class="font-bold">${p.name}${p.isHost ? ' ğŸ‘‘' : ''}</div>
                      <div class="text-xs text-gray-500">åˆ†æ•°:${p.score} | ${p.isReady ? 'å·²å‡†å¤‡' : 'æœªå‡†å¤‡'} | ${p.connected ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
                    </div>
                    <div class="flex gap-1">
                      <button class="px-2 py-1 text-xs sketch-border rounded" onclick="transferHost('${r.id}','${p.name}')">è®¾ä¸ºæˆ¿ä¸»</button>
                      <button class="px-2 py-1 text-xs sketch-border rounded" onclick="prioritizeSubmitter('${r.id}','${p.name}')">ç½®é¡¶å‡ºé¢˜</button>
                      <button class="px-2 py-1 text-xs sketch-border rounded bg-red-100 text-red-600" onclick="kickPlayer('${r.id}','${p.name}')">è¸¢å‡º</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');
      } catch (err) {
        console.error('åŠ è½½æˆ¿é—´å¤±è´¥:', err);
      }
    }

    async function dissolveRoom(roomId) {
      if (!confirm('ç¡®å®šè¦è§£æ•£è¿™ä¸ªæˆ¿é—´å—ï¼Ÿ')) return;
      await apiDelete(`/api/admin/rooms/${roomId}`);
      loadRooms();
    }

    async function kickPlayer(roomId, playerName) {
      await apiPost(`/api/admin/rooms/${roomId}/kick`, { playerName });
      loadRooms();
    }

    async function transferHost(roomId, playerName) {
      await apiPost(`/api/admin/rooms/${roomId}/transfer-host`, { playerName });
      loadRooms();
    }

    async function prioritizeSubmitter(roomId, playerName) {
      await apiPost(`/api/admin/rooms/${roomId}/assign-submitter`, { playerName });
      loadRooms();
    }

    async function loadErrors() {
      try {
        const source = document.getElementById('error-source').value;
        const { data } = await apiGet(`/api/admin/telemetry?type=error${source ? '&source=' + source : ''}&limit=50`);
        document.getElementById('errors-list').innerHTML = data.length === 0
          ? '<p class="text-gray-500 text-center py-4">æš‚æ— é”™è¯¯æ—¥å¿—</p>'
          : data.map(e => `
            <div class="p-3 bg-red-50 rounded border-l-4 border-red-400">
              <div class="flex justify-between">
                <span class="font-bold text-red-700">${e.source === 'client' ? 'ğŸ–¥ï¸ å®¢æˆ·ç«¯' : 'ğŸ–§ æœåŠ¡ç«¯'}</span>
                <span class="text-gray-500 text-xs">${new Date(e.timestamp).toLocaleString()}</span>
              </div>
              <div class="text-sm mt-1">${e.message || 'æ— æ¶ˆæ¯'}</div>
              ${e.ip ? `<div class="text-xs text-gray-500">IP: ${e.ip}</div>` : ''}
              ${e.stack ? `<pre class="text-xs text-gray-500 mt-2 overflow-auto max-h-20">${e.stack}</pre>` : ''}
            </div>
          `).join('');
      } catch (err) {
        console.error('åŠ è½½é”™è¯¯æ—¥å¿—å¤±è´¥:', err);
      }
    }

  </script>
</body>
</html>
